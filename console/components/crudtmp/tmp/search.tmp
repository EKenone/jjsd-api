<?php


namespace {{BASE_NAMESPACE}}\search;


use common\traits\SearchModelScenesTrait;
use yii\data\ActiveDataProvider;
use yii\db\ActiveQuery;

class {{MODEL_NAME}}Search extends \{{RESOURCE}}
{
    use SearchModelScenesTrait;

    public $keyword;
    public $created_start;
    public $created_end;
    public $no_page;

    /**
     * @return array|array[]
     */
    public function rules()
    {
        return [
            [['keyword'], 'trim'],
            [['no_page'], 'in', 'range' => [1, 0]],
            [['created_start', 'created_end',  $this->scenesProperty()], 'safe'],
            [[$this->scenesProperty()], 'in', 'range' => [self::FIELD_INDEX]], // 资源字段场景值
        ];
    }

    /**
     * @return ActiveQuery
     */
    public function baseQuery(): ActiveQuery
    {
        // 这里添加sql必定会存在的语句处理，例如：查询非删除数据，格式如下
        // self::find()->notDelete();
        return self::find();
    }

    /**
     * @param ActiveQuery|null $query
     * @return ActiveDataProvider
     */
    public function search(ActiveQuery $query = null): ActiveDataProvider
    {
        $dataProvider = new ActiveDataProvider([
            'query' => $query
        ]);

        if ($this->keyword) {
            $query->andWhere(['like', self::withDatabaseName('title'), $this->keyword]);
        }

        if ($this->created_start) {
            $query->andWhere(['>=', self::withDatabaseName('created_at'), strtotime($this->created_start)]);
        }

        if ($this->created_end) {
            $query->andWhere(['<=', self::withDatabaseName('created_at'), strtotime($this->created_end)]);
        }

        if ($this->no_page) {
            $dataProvider->pagination = false;
        }

        $query->addOrderBy([self::withDatabaseName('id') => SORT_DESC]);

        return $dataProvider;
    }

    /**
     * 这里是index场景对sql的特殊处理
     * @param ActiveQuery $query
     */
    protected function scenesIndex(ActiveQuery $query)
    {
        // $query->with(['customer']);
    }
}